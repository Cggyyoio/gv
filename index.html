<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صانع قرآن (نسخة تيك توك)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Amiri', serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #34d399; border-radius: 3px; }
    </style>
</head>
<body class="bg-black text-white min-h-screen flex flex-col items-center justify-center p-2">

<div id="root" class="w-full max-w-lg"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const RECITERS = [
        { id: 'Alafasy_128kbps', name: 'مشاري العفاسي' },
        { id: 'MaherAlMuaiqly_64kbps', name: 'ماهر المعيقلي' },
        { id: 'Husary_128kbps', name: 'محمود خليل الحصري' },
        { id: 'Minshawy_Murattal_128kbps', name: 'محمد صديق المنشاوي' },
        { id: 'Ghamadi_40kbps', name: 'سعد الغامدي' },
        { id: 'Yasser_Ad-Dussary_128kbps', name: 'ياسر الدوسري' }
    ];

    function App() {
        const [surahs, setSurahs] = useState([]);
        const [selectedSurah, setSelectedSurah] = useState(null);
        const [reciter, setReciter] = useState(RECITERS[0].id);
        const [startAyah, setStartAyah] = useState(1);
        const [endAyah, setEndAyah] = useState(2); // تقليل الافتراضي لتيك توك
        
        const [status, setStatus] = useState('idle');
        const [logs, setLogs] = useState('جاهز');
        const [videoUrl, setVideoUrl] = useState(null);
        const [fileExt, setFileExt] = useState('mp4');

        const canvasRef = useRef(null);
        const audioContextRef = useRef(null);
        const mediaRecorderRef = useRef(null);
        const chunksRef = useRef([]);

        useEffect(() => {
            fetch('https://api.alquran.cloud/v1/surah')
                .then(r => r.json())
                .then(data => {
                    setSurahs(data.data);
                    setSelectedSurah(data.data[0]);
                });
        }, []);

        const formatNumber = (num) => String(num).padStart(3, '0');

        // --- الرسم بتنسيق تيك توك (طولي) ---
        const drawFrame = (text, ayahNum, surahName) => {
            const canvas = canvasRef.current;
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            // أبعاد تيك توك HD
            canvas.width = 720;
            canvas.height = 1280;

            // 1. الخلفية (داكنة جداً لراحة العين)
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#0f172a'); // slate-900
            gradient.addColorStop(1, '#020617'); // slate-950
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // زخرفة بسيطة
            ctx.strokeStyle = '#34d399';
            ctx.lineWidth = 3;
            ctx.strokeRect(40, 40, canvas.width - 80, canvas.height - 80);

            // 2. اسم السورة (أعلى)
            if(surahName) {
                ctx.shadowColor = "rgba(52, 211, 153, 0.5)";
                ctx.shadowBlur = 15;
                ctx.fillStyle = '#34d399';
                ctx.font = 'bold 50px Amiri';
                ctx.textAlign = 'center';
                ctx.fillText(`سورة ${surahName}`, canvas.width / 2, 180);
                ctx.shadowBlur = 0;
            }

            // 3. النص القرآني (وسط)
            ctx.fillStyle = '#ffffff';
            ctx.textBaseline = 'middle';
            
            // حساب حجم الخط ديناميكياً
            let fontSize = 60;
            if (text.length > 100) fontSize = 55;
            if (text.length > 200) fontSize = 45;
            if (text.length > 350) fontSize = 38;
            
            ctx.font = `${fontSize}px Amiri`;
            
            // التفاف النص (Word Wrap) للمقاس الطولي
            const maxWidth = canvas.width - 120;
            const words = text.split(' ');
            let lines = [];
            let currentLine = words[0];

            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const width = ctx.measureText(currentLine + " " + word).width;
                if (width < maxWidth) {
                    currentLine += " " + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);

            const lineHeight = fontSize * 1.8;
            // توسيط الكتلة النصية عمودياً
            const totalHeight = lines.length * lineHeight;
            let startY = (canvas.height - totalHeight) / 2;

            lines.forEach((line, i) => {
                ctx.fillText(line, canvas.width / 2, startY + (i * lineHeight));
            });

            // 4. رقم الآية (أسفل)
            if(ayahNum) {
                ctx.fillStyle = '#94a3b8';
                ctx.font = '40px Amiri';
                ctx.fillText(`الآية ${ayahNum}`, canvas.width / 2, canvas.height - 150);
            }
            
            // حقوق أو اسم القارئ
            const reciterName = RECITERS.find(r => r.id === reciter)?.name || "";
            ctx.font = '30px Amiri';
            ctx.fillStyle = '#334155';
            ctx.fillText(reciterName, canvas.width / 2, canvas.height - 80);
        };

        useEffect(() => {
            const t = setTimeout(() => drawFrame("بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ", "", ""), 500);
            return () => clearTimeout(t);
        }, []);

        // --- محرك البحث عن كوديك H.264 (المقبول في تيك توك) ---
        const getTikTokCompatibleMimeType = () => {
            const types = [
                // الترتيب مهم: نحاول إيجاد H.264 MP4 أولاً
                "video/mp4; codecs=avc1.42E01E, mp4a.40.2", // Baseline profile (الأكثر توافقاً)
                "video/mp4; codecs=avc1.4d401e, mp4a.40.2", // Main profile
                "video/mp4; codecs=avc1.64001e, mp4a.40.2", // High profile
                "video/mp4", // عام
                "video/webm; codecs=h264", // WebM مع كوديك فيديو H.264
                "video/webm" // الخيار الأخير (سيحتاج تحويل)
            ];
            
            for (const type of types) {
                if (MediaRecorder.isTypeSupported(type)) {
                    console.log("Selected MIME:", type);
                    return type;
                }
            }
            return "";
        };

        const startCreation = async () => {
            setStatus('processing');
            setVideoUrl(null);
            setLogs("تجهيز...");

            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const actx = new AudioContext();
                await actx.resume();
                audioContextRef.current = actx;

                const canvas = canvasRef.current;
                const canvasStream = canvas.captureStream(30);
                const audioDest = actx.createMediaStreamDestination();
                
                const combinedStream = new MediaStream([
                    ...canvasStream.getVideoTracks(),
                    ...audioDest.stream.getAudioTracks()
                ]);

                const mimeType = getTikTokCompatibleMimeType();
                // إذا كان النوع ليس MP4 صريحاً، نغير الامتداد لـ webm وننبه المستخدم
                const isMp4Compatible = mimeType.includes("mp4") || mimeType.includes("avc1");
                setFileExt(isMp4Compatible ? 'mp4' : 'webm');

                const recorder = new MediaRecorder(combinedStream, { 
                    mimeType: mimeType,
                    videoBitsPerSecond: 4000000 // 4 Mbps (جودة عالية لتيك توك)
                });

                chunksRef.current = [];
                recorder.ondataavailable = e => { if (e.data.size > 0) chunksRef.current.push(e.data); };
                
                recorder.onstop = () => {
                    const blob = new Blob(chunksRef.current, { type: mimeType });
                    setVideoUrl(URL.createObjectURL(blob));
                    setStatus('done');
                    setLogs(isMp4Compatible 
                        ? "تم! الملف جاهز لتيك توك." 
                        : "تنبيه: متصفحك لا يدعم MP4 الأصلي. حمل الملف ثم استخدم تطبيق مونتاج لحفظه كـ MP4 قبل الرفع.");
                    actx.close();
                };

                recorder.start();
                mediaRecorderRef.current = recorder;

                for (let i = parseInt(startAyah); i <= parseInt(endAyah); i++) {
                    setLogs(`تسجيل آية ${i}...`);
                    
                    const textUrl = `https://api.alquran.cloud/v1/ayah/${selectedSurah.number}:${i}/quran-simple-enhanced`;
                    const textRes = await fetch(textUrl);
                    const textJson = await textRes.json();
                    
                    drawFrame(textJson.data.text, textJson.data.numberInSurah, selectedSurah.name);

                    const audioUrl = `https://everyayah.com/data/${reciter}/${formatNumber(selectedSurah.number)}${formatNumber(i)}.mp3`;
                    await playAudio(audioUrl, actx, audioDest);
                    await new Promise(r => setTimeout(r, 500)); // وقفة قصيرة بين الآيات
                }

                recorder.stop();

            } catch (err) {
                console.error(err);
                setLogs("حدث خطأ تقني. حاول مرة أخرى.");
                setStatus('idle');
            }
        };

        const playAudio = (url, actx, dest) => {
            return new Promise((resolve) => {
                const audio = new Audio();
                audio.crossOrigin = "anonymous";
                audio.src = url;
                
                const source = actx.createMediaElementSource(audio);
                source.connect(dest);
                source.connect(actx.destination);

                audio.onended = resolve;
                audio.onerror = resolve; // تخطي عند الخطأ
                audio.play().catch(resolve);
            });
        };

        return (
            <div className="w-full bg-slate-900 border border-slate-800 rounded-xl overflow-hidden shadow-2xl">
                <div className="p-4 bg-emerald-900/20 text-center border-b border-slate-800">
                    <h1 className="text-2xl font-bold text-emerald-400">صانع قرآن (تيك توك)</h1>
                    <p className="text-xs text-slate-400 mt-1">مقاس طولي 9:16 + جودة عالية</p>
                </div>

                <div className="p-4 space-y-4">
                    {/* أدوات التحكم */}
                    <div className="space-y-3 text-sm">
                        <div>
                            <label className="text-slate-400 block mb-1">اختر السورة</label>
                            <select 
                                className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white"
                                onChange={e => {
                                    const s = surahs.find(x => x.number == e.target.value);
                                    setSelectedSurah(s);
                                    setStartAyah(1);
                                    setEndAyah(2);
                                }}
                            >
                                {surahs.map(s => <option key={s.number} value={s.number}>{s.number}. {s.name}</option>)}
                            </select>
                        </div>

                        <div className="grid grid-cols-2 gap-2">
                            <div>
                                <label className="text-slate-400 block mb-1">من آية</label>
                                <input type="number" min="1" value={startAyah} onChange={e=>setStartAyah(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-center" />
                            </div>
                            <div>
                                <label className="text-slate-400 block mb-1">إلى آية</label>
                                <input type="number" min="1" value={endAyah} onChange={e=>setEndAyah(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-center" />
                            </div>
                        </div>

                         <div>
                            <label className="text-slate-400 block mb-1">القارئ</label>
                            <select 
                                className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white"
                                onChange={e => setReciter(e.target.value)}
                            >
                                {RECITERS.map(r => <option key={r.id} value={r.id}>{r.name}</option>)}
                            </select>
                        </div>
                    </div>

                    {/* زر التشغيل */}
                    <button 
                        onClick={startCreation}
                        disabled={status === 'processing'}
                        className={`w-full py-3 rounded-lg font-bold transition flex items-center justify-center gap-2 ${
                            status === 'processing' 
                            ? 'bg-slate-700 text-slate-400' 
                            : 'bg-emerald-600 hover:bg-emerald-500 text-white'
                        }`}
                    >
                        {status === 'processing' ? (
                            <>
                                <span className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
                                جاري الإنشاء...
                            </>
                        ) : 'بدء التسجيل'}
                    </button>

                    {/* المعاينة (أبعاد الهاتف) */}
                    <div className="flex justify-center bg-black/50 p-2 rounded-lg border border-slate-800">
                        <div className="relative w-[180px] h-[320px] bg-black border border-slate-700 rounded-lg overflow-hidden shadow-lg">
                            <canvas ref={canvasRef} className="w-full h-full object-contain"></canvas>
                        </div>
                    </div>

                    {/* حالة النظام وزر التحميل */}
                    <div className="text-center space-y-3">
                        <p className={`text-xs font-mono p-2 rounded ${
                            logs.includes("تنبيه") ? "bg-yellow-900/30 text-yellow-200" : "bg-slate-800 text-emerald-300"
                        }`}>
                            {logs}
                        </p>

                        {videoUrl && (
                            <a 
                                href={videoUrl} 
                                download={`Quran_${selectedSurah?.number}_TikTok.${fileExt}`}
                                className="block w-full bg-slate-100 hover:bg-white text-black font-bold py-3 rounded-lg animate-pulse"
                            >
                                ⬇️ تحميل الفيديو ({fileExt.toUpperCase()})
                            </a>
                        )}
                        
                        {/* نصيحة للمستخدم في حال ظهرت رسالة خطأ في تيك توك */}
                        {fileExt === 'webm' && videoUrl && (
                            <div className="text-[10px] text-yellow-500 bg-yellow-900/20 p-2 rounded text-right">
                                ⚠️ <b>هام:</b> تم الحفظ بصيغة WebM لأن متصفحك لا يدعم MP4. 
                                <br/>
                                لحل مشكلة "تعذر فك الشفرة" في تيك توك:
                                1. حمل الفيديو.
                                2. افتحه في تطبيق CapCut أو InShot.
                                3. اضغط حفظ (Export).
                                4. ارفعه لتيك توك.
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>

</body>
</html>

