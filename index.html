<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منشئ فيديو القرآن الكريم</title>
    
    <!-- مكتبات التشغيل -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- خطوط عربية احترافية -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Kufi+Arabic:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        /* إعدادات الخطوط العامة */
        body { 
            font-family: 'Noto Kufi Arabic', sans-serif; 
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0;
        }
        .quran-text { font-family: 'Amiri', serif; }
        
        /* تحسينات عناصر التحكم */
        .custom-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: left 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
        
        /* إخفاء شريط التمرير للمتصفحات */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

<div id="root" class="flex-grow"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // قائمة القراء
    const RECITERS = [
        { id: 'Minshawy_Murattal_128kbps', name: 'محمد صديق المنشاوي (مرتل)' },
        { id: 'Minshawy_Mujawwad_192kbps', name: 'محمد صديق المنشاوي (مجود)' },
        { id: 'Abdul_Basit_Murattal_64kbps', name: 'عبدالباسط عبدالصمد (مرتل)' },
        { id: 'Abdul_Basit_Mujawwad_128kbps', name: 'عبدالباسط عبدالصمد (مجود)' },
        { id: 'Alafasy_128kbps', name: 'مشاري العفاسي' },
        { id: 'Husary_128kbps', name: 'محمود خليل الحصري (مرتل)' },
        { id: 'Husary_Mujawwad_128kbps', name: 'محمود خليل الحصري (مجود)' },
        { id: 'MaherAlMuaiqly_64kbps', name: 'ماهر المعيقلي' },
        { id: 'Ghamadi_40kbps', name: 'سعد الغامدي' },
        { id: 'Yasser_Ad-Dussary_128kbps', name: 'ياسر الدوسري' },
        { id: 'Nasser_Alqatami_128kbps', name: 'ناصر القطامي' }
    ];

    function App() {
        const [surahs, setSurahs] = useState([]);
        const [selectedSurah, setSelectedSurah] = useState(null);
        const [reciter, setReciter] = useState(RECITERS[0].id);
        const [startAyah, setStartAyah] = useState(1);
        const [endAyah, setEndAyah] = useState(3);
        const [status, setStatus] = useState('idle'); // idle, processing, done, error
        const [progressText, setProgressText] = useState('');
        const [videoUrl, setVideoUrl] = useState(null);

        const canvasRef = useRef(null);
        const audioContextRef = useRef(null);
        const mediaRecorderRef = useRef(null);
        const chunksRef = useRef([]);

        // جلب البيانات عند التحميل
        useEffect(() => {
            fetch('https://api.alquran.cloud/v1/surah')
                .then(r => r.json())
                .then(data => {
                    setSurahs(data.data);
                    setSelectedSurah(data.data[0]);
                })
                .catch(() => setProgressText("تأكد من اتصال الإنترنت"));
        }, []);

        const formatNumber = (num) => String(num).padStart(3, '0');

        // وظيفة الرسم على الـ Canvas
        const drawFrame = (text, ayahNum, surahName) => {
            const canvas = canvasRef.current;
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            canvas.width = 1920; // جودة Full HD
            canvas.height = 1080;

            // الخلفية
            ctx.fillStyle = '#111827'; // رمادي داكن جداً
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // زخرفة إطار بسيطة جداً وأنيقة
            ctx.strokeStyle = '#374151'; // رمادي فاتح قليلاً
            ctx.lineWidth = 2;
            const padding = 50;
            ctx.strokeRect(padding, padding, canvas.width - (padding*2), canvas.height - (padding*2));

            // اسم السورة (أعلى الوسط)
            ctx.fillStyle = '#10b981'; // أخضر هادئ
            ctx.font = 'bold 60px Amiri';
            ctx.textAlign = 'center';
            if(surahName) ctx.fillText(`سورة ${surahName}`, canvas.width / 2, 140);

            // رقم الآية (أسفل)
            ctx.fillStyle = '#6b7280'; // رمادي للنصوص الثانوية
            ctx.font = '40px Amiri';
            if(ayahNum) ctx.fillText(`الآية ${ayahNum}`, canvas.width / 2, canvas.height - 100);

            // النص القرآني
            ctx.fillStyle = '#f3f4f6'; // أبيض مائل للرمادي (مريح للعين)
            
            // حساب حجم الخط ديناميكياً
            let fontSize = 100;
            if (text.length > 200) fontSize = 80;
            if (text.length > 400) fontSize = 65;
            
            ctx.font = `${fontSize}px Amiri`;
            ctx.textBaseline = 'middle';

            // التفاف النص (Word Wrap)
            const maxWidth = canvas.width - 400;
            const words = text.split(' ');
            let lines = [];
            let currentLine = words[0];

            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const width = ctx.measureText(currentLine + " " + word).width;
                if (width < maxWidth) {
                    currentLine += " " + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);

            const lineHeight = fontSize * 1.7;
            const totalHeight = lines.length * lineHeight;
            const startY = (canvas.height - totalHeight) / 2 + (lineHeight/2.5);

            lines.forEach((line, i) => {
                ctx.fillText(line, canvas.width / 2, startY + (i * lineHeight));
            });
        };

        // تهيئة أولية للرسم
        useEffect(() => {
            const timer = setTimeout(() => drawFrame("بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ", "", ""), 500);
            return () => clearTimeout(timer);
        }, []);

        // --- منطق المعالجة ---
        const startCreation = async () => {
            if (parseInt(startAyah) > parseInt(endAyah)) {
                alert("رقم آية البداية يجب أن يكون أصغر من النهاية");
                return;
            }

            setStatus('processing');
            setVideoUrl(null);
            setProgressText("تهيئة التسجيل...");

            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const actx = new AudioContext();
                await actx.resume();
                audioContextRef.current = actx;

                const canvas = canvasRef.current;
                const canvasStream = canvas.captureStream(30);
                const audioDest = actx.createMediaStreamDestination();
                
                const combinedStream = new MediaStream([
                    ...canvasStream.getVideoTracks(),
                    ...audioDest.stream.getAudioTracks()
                ]);

                // إعدادات المسجل بجودة عالية
                let mimeType = 'video/webm; codecs=vp9';
                if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = 'video/webm';

                const recorder = new MediaRecorder(combinedStream, { 
                    mimeType,
                    videoBitsPerSecond: 8000000 // 8 Mbps
                });
                
                chunksRef.current = [];
                recorder.ondataavailable = e => { if (e.data.size > 0) chunksRef.current.push(e.data); };
                
                recorder.onstop = () => {
                    const blob = new Blob(chunksRef.current, { type: 'video/webm' });
                    setVideoUrl(URL.createObjectURL(blob));
                    setStatus('done');
                    setProgressText("تم إنشاء الفيديو بنجاح");
                    actx.close();
                };

                recorder.start();
                mediaRecorderRef.current = recorder;

                // الحلقة الرئيسية
                for (let i = parseInt(startAyah); i <= parseInt(endAyah); i++) {
                    setProgressText(`جاري تسجيل الآية ${i} من سورة ${selectedSurah.name}...`);
                    
                    // جلب النص
                    const textRes = await fetch(`https://api.alquran.cloud/v1/ayah/${selectedSurah.number}:${i}/quran-simple-enhanced`);
                    const textJson = await textRes.json();
                    
                    drawFrame(textJson.data.text, textJson.data.numberInSurah, selectedSurah.name);

                    // تشغيل الصوت
                    const audioUrl = `https://everyayah.com/data/${reciter}/${formatNumber(selectedSurah.number)}${formatNumber(i)}.mp3`;
                    await playAudio(audioUrl, actx, audioDest);
                    
                    // فاصل زمني بسيط للصمت بين الآيات
                    await new Promise(r => setTimeout(r, 500));
                }

                recorder.stop();

            } catch (err) {
                console.error(err);
                setProgressText("حدث خطأ غير متوقع، يرجى المحاولة مرة أخرى");
                setStatus('idle');
                if (mediaRecorderRef.current) mediaRecorderRef.current.stop();
            }
        };

        const playAudio = (url, actx, dest) => {
            return new Promise((resolve) => {
                const audio = new Audio();
                audio.crossOrigin = "anonymous";
                audio.src = url;

                const source = actx.createMediaElementSource(audio);
                source.connect(dest);
                source.connect(actx.destination); // للسماع أثناء التسجيل

                audio.onended = () => resolve();
                audio.onerror = () => resolve(); // تخطي في حالة الخطأ
                
                audio.play().catch(() => resolve());
            });
        };

        return (
            <div className="container mx-auto px-4 py-8 max-w-5xl">
                
                {/* العنوان */}
                <header className="mb-8 text-center">
                    <h1 className="text-3xl font-bold text-white mb-2">منشئ فيديو القرآن الكريم</h1>
                    <p className="text-slate-400 text-sm">أنشئ مقاطع مرئية عالية الجودة بسهولة</p>
                </header>

                <div className="grid lg:grid-cols-3 gap-8 items-start">
                    
                    {/* لوحة التحكم (الجانب الأيمن) */}
                    <div className="lg:col-span-1 bg-slate-800 rounded-xl p-6 shadow-lg border border-slate-700">
                        <div className="space-y-5">
                            
                            {/* اختيار السورة */}
                            <div>
                                <label className="block text-slate-300 text-xs font-bold mb-2">السورة</label>
                                <select 
                                    className="w-full bg-slate-900 border border-slate-600 text-white text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block p-3 custom-select"
                                    onChange={e => {
                                        const s = surahs.find(x => x.number == e.target.value);
                                        setSelectedSurah(s);
                                        setStartAyah(1);
                                        setEndAyah(3);
                                    }}
                                >
                                    {surahs.map(s => <option key={s.number} value={s.number}>{s.number}. {s.name}</option>)}
                                </select>
                            </div>

                            {/* نطاق الآيات */}
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="block text-slate-300 text-xs font-bold mb-2">من الآية</label>
                                    <input 
                                        type="number" 
                                        min="1" 
                                        value={startAyah} 
                                        onChange={e=>setStartAyah(e.target.value)} 
                                        className="bg-slate-900 border border-slate-600 text-white text-sm rounded-lg block w-full p-3 text-center focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none" 
                                    />
                                </div>
                                <div>
                                    <label className="block text-slate-300 text-xs font-bold mb-2">إلى الآية</label>
                                    <input 
                                        type="number" 
                                        min="1" 
                                        value={endAyah} 
                                        onChange={e=>setEndAyah(e.target.value)} 
                                        className="bg-slate-900 border border-slate-600 text-white text-sm rounded-lg block w-full p-3 text-center focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none" 
                                    />
                                </div>
                            </div>

                            {/* القارئ */}
                            <div>
                                <label className="block text-slate-300 text-xs font-bold mb-2">القارئ</label>
                                <select 
                                    className="w-full bg-slate-900 border border-slate-600 text-white text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block p-3 custom-select"
                                    onChange={e => setReciter(e.target.value)}
                                >
                                    {RECITERS.map(r => <option key={r.id} value={r.id}>{r.name}</option>)}
                                </select>
                            </div>

                            {/* زر الإجراء */}
                            <button 
                                onClick={startCreation}
                                disabled={status === 'processing'}
                                className={`w-full text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 mt-2 ${
                                    status === 'processing' 
                                    ? 'bg-slate-600 cursor-not-allowed' 
                                    : 'bg-emerald-600 hover:bg-emerald-700 active:bg-emerald-800'
                                }`}
                            >
                                {status === 'processing' ? 'جاري المعالجة...' : 'إنشاء الفيديو'}
                            </button>

                            {/* حالة النظام */}
                            {progressText && (
                                <div className="text-xs text-center text-emerald-400 font-mono pt-2 border-t border-slate-700 mt-2">
                                    {progressText}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* منطقة العرض (الجانب الأيسر) */}
                    <div className="lg:col-span-2 space-y-4">
                        {/* حاوية الفيديو */}
                        <div className="bg-black rounded-xl overflow-hidden shadow-2xl border border-slate-700 relative aspect-video group">
                            <canvas ref={canvasRef} className="w-full h-full object-contain"></canvas>
                            
                            {/* مؤشر التسجيل */}
                            {status === 'processing' && (
                                <div className="absolute top-4 right-4 flex items-center gap-2 bg-red-600/90 text-white text-[10px] px-2 py-1 rounded-md backdrop-blur-sm">
                                    <span className="w-2 h-2 bg-white rounded-full animate-pulse"></span>
                                    <span>تسجيل مباشر</span>
                                </div>
                            )}
                        </div>

                        {/* زر التحميل عند الانتهاء */}
                        {videoUrl && (
                            <div className="bg-emerald-900/30 border border-emerald-500/30 rounded-lg p-4 flex items-center justify-between">
                                <div className="text-sm">
                                    <p className="text-white font-bold">تم اكتمال الفيديو</p>
                                    <p className="text-emerald-200/60 text-xs">سورة {selectedSurah?.name}</p>
                                </div>
                                <a 
                                    href={videoUrl} 
                                    download={`Quran_Video_${selectedSurah?.number}.webm`}
                                    className="bg-emerald-600 hover:bg-emerald-500 text-white text-sm px-4 py-2 rounded-md transition-colors flex items-center gap-2"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                                    تحميل
                                </a>
                            </div>
                        )}
                    </div>
                </div>

                {/* التذييل */}
                <footer className="mt-16 pt-8 border-t border-slate-800 text-center">
                    <p className="text-emerald-500 text-lg mb-4 quran-text">" فِي سَبِيلِ اللَّهِ "</p>
                    <div className="flex flex-col md:flex-row justify-center items-center gap-2 md:gap-8 text-slate-500 text-sm">
                        <span>محمد رضا</span>
                        <span className="hidden md:inline text-slate-700">•</span>
                        <a 
                            href="https://wa.me/201002495127" 
                            target="_blank" 
                            rel="noopener noreferrer"
                            dir="ltr" 
                            className="font-mono hover:text-emerald-500 transition-colors flex items-center gap-1"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                            01002495127
                        </a>
                    </div>
                </footer>

            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>

</body>
</html>



